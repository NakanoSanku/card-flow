---
import Layout from '../layouts/Layout.astro';
import Main from '../components/Main';
import { getCollection } from 'astro:content';
import { Marked } from 'marked';
import { markedHighlight } from 'marked-highlight';
import hljs from 'highlight.js';

const marked = new Marked(
  markedHighlight({
    langPrefix: 'hljs language-',
    highlight(code, lang) {
      const language = hljs.getLanguage(lang) ? lang : 'plaintext';
      return hljs.highlight(code, { language }).value;
    }
  })
);

const renderer = {
  code({ text, lang }) {
    const language = lang || 'plaintext';
    return `
      <div class="mac-window my-6 rounded-lg overflow-hidden border border-zinc-200 dark:border-zinc-800 bg-[#282c34] shadow-md" data-code-block data-expanded="false">
        <div class="mac-header flex items-center justify-between px-4 py-2 bg-zinc-100 dark:bg-zinc-900 border-b border-zinc-200 dark:border-zinc-800">
          <div class="mac-dots flex gap-1.5">
            <div class="w-3 h-3 rounded-full bg-[#ff5f56]"></div>
            <div class="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>
            <div class="w-3 h-3 rounded-full bg-[#27c93f]"></div>
          </div>
          <div class="mac-title text-xs font-medium text-zinc-500 dark:text-zinc-400 select-none">
            ${language}
          </div>
          <div class="flex items-center gap-2">
            <button type="button" class="text-[11px] px-2 py-1 rounded bg-white/80 dark:bg-zinc-800/80 text-zinc-600 dark:text-zinc-300 border border-zinc-200 dark:border-zinc-700 hover:bg-white hover:text-zinc-800 dark:hover:bg-zinc-700/80 transition" data-copy-btn>
              Copy
            </button>
            <button type="button" class="text-[11px] px-2 py-1 rounded bg-white/80 dark:bg-zinc-800/80 text-zinc-600 dark:text-zinc-300 border border-zinc-200 dark:border-zinc-700 hover:bg-white hover:text-zinc-800 dark:hover:bg-zinc-700/80 transition" data-toggle-btn>
              Expand
            </button>
          </div>
        </div>
        <div class="relative p-4">
          <div class="code-content max-h-64 overflow-hidden overflow-x-auto" data-code-content>
            <pre class="m-0"><code class="hljs language-${language}">${text}</code></pre>
          </div>
          <div class="pointer-events-none absolute inset-x-4 bottom-0 h-14 bg-gradient-to-t from-[#282c34] via-[#282c34]/70 to-transparent" data-code-fade></div>
        </div>
      </div>
    `;
  }
};

marked.use({ renderer });

// Fetch all posts
const posts = await getCollection('posts');

// Get all unique card types (ensure all supported types, even if no posts yet)
const baseTypes = ['prompt', 'script', 'video', 'app', 'github', 'website'];
const allTypes = [...new Set([...baseTypes, ...posts.map(post => post.data.type)])];

// Pre-render content to HTML
const renderedPosts = await Promise.all(posts.map(async (post) => {
  const html = await marked.parse(post.body);
  return {
    ...post,
    body: html
  };
}));
---

<Layout>
	<Main client:load initialPosts={renderedPosts} allTypes={allTypes} />
</Layout>
